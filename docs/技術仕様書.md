# 技術仕様書 - Strategic AI Platform

## 🏗️ システム詳細仕様

### アーキテクチャ概要

本システムは、React フロントエンドと AWS サーバーレス基盤を組み合わせた、モダンな売上分析プラットフォームです。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   AWS Cloud     │    │   AI Service    │
│                 │    │                 │    │                 │
│  React + TS     │◄──►│  API Gateway    │◄──►│  Bedrock        │
│  Vite + Vercel  │    │  Lambda         │    │  Claude 3       │
│  Recharts       │    │  CORS + Auth    │    │  Natural Lang   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📱 フロントエンド仕様

### React アプリケーション構成

**ディレクトリ構造**
```
src/
├── App.tsx                 # メインアプリケーション
├── main.tsx               # エントリーポイント
├── index.css              # グローバルスタイル
├── App.css                # アプリ固有スタイル
├── vite-env.d.ts          # Vite型定義
└── assets/                # 静的リソース
    └── react.svg
```

### コンポーネント詳細仕様

#### App.tsx - メインコンポーネント

**状態管理**
```typescript
interface AppState {
  prompt: string;              // ユーザー入力質問
  response: string;            // AI応答結果
  isLoading: boolean;          // ローディング状態
  salesData: SalesData[];      // アップロードされた売上データ
  isFileUploaded: boolean;     // ファイルアップロード状態
  showCharts: boolean;         // グラフ表示フラグ
  isDragging: boolean;         // ドラッグ状態
}
```

**主要関数**
```typescript
// ファイル処理
const processFile = (file: File) => void;
const handleFileUpload = (event: ChangeEvent<HTMLInputElement>) => void;
const handleDragOver = (e: DragEvent<HTMLDivElement>) => void;
const handleDragLeave = (e: DragEvent<HTMLDivElement>) => void;
const handleDrop = (e: DragEvent<HTMLDivElement>) => void;

// API通信
const handleSubmit = () => Promise<void>;

// データ分析
const analyzeSalesData = (data: SalesData[]) => AnalysisResult | null;
const generateChartData = () => ChartData | null;
```

### UI/UX 仕様

**レスポンシブデザイン**
- 最大幅: 800px
- モバイル対応: 320px以上
- タブレット対応: 768px以上

**カラーパレット**
```css
:root {
  --primary-blue: #007bff;
  --success-green: #28a745;
  --warning-yellow: #ffc107;
  --danger-red: #dc3545;
  --light-gray: #f8f9fa;
  --border-gray: #ddd;
}
```

**インタラクション**
- ホバー効果: 0.3s transition
- ドラッグ&ドロップ: ビジュアルフィードバック
- ローディング: スピナー + メッセージ

## 🔧 データ処理仕様

### CSV ファイル解析

**対応形式**
- CSV (.csv)
- Excel (.xlsx, .xls)
- 文字エンコーディング: UTF-8, Shift-JIS

**Papa Parse 設定**
```typescript
Papa.parse(file, {
  complete: (results) => { /* 処理 */ },
  header: true,              // ヘッダー行を使用
  skipEmptyLines: true,      // 空行をスキップ
  error: (error) => { /* エラー処理 */ }
});
```

### カラム自動検出

**検出ロジック**
```typescript
// 日付カラム検出
const dateColumns = Object.keys(data[0]).filter(key => 
  key.toLowerCase().includes('date') || 
  key.toLowerCase().includes('日付') ||
  key.toLowerCase().includes('年月')
);

// 売上カラム検出
const salesColumns = Object.keys(data[0]).filter(key => 
  key.toLowerCase().includes('sales') || 
  key.toLowerCase().includes('売上') ||
  key.toLowerCase().includes('金額') ||
  key.toLowerCase().includes('amount')
);

// 商品カラム検出
const productColumns = Object.keys(data[0]).filter(key => 
  key.toLowerCase().includes('product') || 
  key.toLowerCase().includes('商品') ||
  key.toLowerCase().includes('item') ||
  key.toLowerCase().includes('名前')
);
```

### データ可視化仕様

**Recharts 設定**
```typescript
// 折れ線グラフ
<LineChart data={monthlyData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="month" />
  <YAxis />
  <Tooltip formatter={(value) => [`¥${Number(value).toLocaleString()}`, '売上']} />
  <Legend />
  <Line type="monotone" dataKey="sales" stroke="#8884d8" strokeWidth={2} />
</LineChart>

// 円グラフ
<PieChart>
  <Pie
    data={productData}
    cx="50%"
    cy="50%"
    labelLine={false}
    label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
    outerRadius={80}
    fill="#8884d8"
    dataKey="value"
  />
</PieChart>
```

## 🌐 API 通信仕様

### HTTP リクエスト

**エンドポイント**
```
開発環境: http://localhost:5174/api (Viteプロキシ)
本番環境: https://ylgrnwffx6.execute-api.us-east-1.amazonaws.com
```

**リクエスト形式**
```typescript
interface APIRequest {
  prompt: string;                    // ユーザー質問
  salesData?: SalesData[] | null;    // 売上データ（最大50行）
}

// 実際のリクエスト
const requestData = {
  prompt: prompt,
  salesData: isFileUploaded ? salesData.slice(0, 50) : null
};

const result = await axios.post(API_ENDPOINT, requestData, {
  headers: {
    'Content-Type': 'application/json',
  }
});
```

**レスポンス形式**
```typescript
interface APIResponse {
  response?: string;    // AI分析結果
  message?: string;     // システムメッセージ  
  data?: any;          // 追加データ
}
```

### エラーハンドリング

```typescript
try {
  const result = await axios.post(API_ENDPOINT, requestData);
  setResponse(result.data.response || result.data.message || JSON.stringify(result.data));
} catch (error: any) {
  if (error.response) {
    // サーバーエラー (4xx, 5xx)
    setResponse(`サーバーエラー: ${error.response.status} - ${error.response.data?.message || error.response.statusText}`);
  } else if (error.request) {
    // ネットワークエラー
    setResponse('APIからレスポンスがありません。CORSエラーの可能性があります。');
  } else {
    // その他のエラー
    setResponse(`エラー: ${error.message}`);
  }
}
```

## ☁️ AWS バックエンド仕様

### API Gateway 設定

**エンドポイント構成**
```
メソッド: POST
パス: /
リージョン: us-east-1
認証: なし（Open API）
CORS: 有効
```

**リクエスト/レスポンス変換**
```json
{
  "Integration Request": {
    "type": "AWS_PROXY",
    "uri": "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/{LambdaArn}/invocations"
  },
  "Integration Response": {
    "statusCode": 200,
    "responseParameters": {
      "method.response.header.Access-Control-Allow-Origin": "'*'"
    }
  }
}
```

### Lambda 関数仕様

**ランタイム環境**
```
Runtime: Python 3.11
Memory: 1024 MB
Timeout: 30 seconds
Environment Variables:
  - AWS_REGION=us-east-1
```

**関数構造（推定）**
```python
import boto3
import json
import logging

logger = logging.getLogger()
logger.setLevel(logging.INFO)

def lambda_handler(event, context):
    try:
        # 1. リクエスト解析
        body = json.loads(event.get('body', '{}'))
        prompt = body.get('prompt', '')
        sales_data = body.get('salesData', [])
        
        logger.info(f"Received prompt: {prompt}")
        logger.info(f"Sales data rows: {len(sales_data)}")
        
        # 2. 入力バリデーション
        if not prompt:
            return response_builder(400, "プロンプトが必要です")
        
        # 3. Bedrock クライアント初期化
        bedrock = boto3.client(
            service_name='bedrock-runtime',
            region_name='us-east-1'
        )
        
        # 4. プロンプト構築
        enhanced_prompt = build_analysis_prompt(prompt, sales_data)
        
        # 5. Claude 3 API 呼び出し
        request_body = {
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": 2000,
            "temperature": 0.1,
            "messages": [
                {
                    "role": "user",
                    "content": enhanced_prompt
                }
            ]
        }
        
        response = bedrock.invoke_model(
            modelId='anthropic.claude-3-sonnet-20240229-v1:0',
            body=json.dumps(request_body)
        )
        
        # 6. レスポンス解析
        response_body = json.loads(response['body'].read())
        ai_response = response_body['content'][0]['text']
        
        logger.info("Bedrock response received successfully")
        
        # 7. 成功レスポンス
        return response_builder(200, {
            'response': ai_response,
            'message': '分析が完了しました'
        })
        
    except Exception as e:
        logger.error(f"Error: {str(e)}")
        return response_builder(500, f"サーバー内部エラー: {str(e)}")

def build_analysis_prompt(user_prompt, sales_data):
    """分析用プロンプトの構築"""
    base_prompt = f"""
あなたは売上データ分析の専門家です。以下の売上データを分析し、ユーザーの質問に回答してください。

【ユーザーの質問】
{user_prompt}

【売上データ】
"""
    
    if sales_data:
        # データサマリーを追加
        base_prompt += f"データ行数: {len(sales_data)}行\n"
        base_prompt += f"データサンプル:\n{json.dumps(sales_data[:3], ensure_ascii=False, indent=2)}\n"
    else:
        base_prompt += "データが提供されていません。一般的な売上分析のアドバイスを提供してください。\n"
    
    base_prompt += """
【分析要件】
1. 提供されたデータの特徴と傾向を分析
2. 具体的な数値と根拠を示す
3. ビジネスへの影響を評価
4. 実用的な改善提案を含める
5. 日本語で分かりやすく回答

【回答】
"""
    
    return base_prompt

def response_builder(status_code, body):
    """CORS対応レスポンスビルダー"""
    if isinstance(body, str):
        response_body = {"message": body}
    else:
        response_body = body
    
    return {
        'statusCode': status_code,
        'headers': {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type',
            'Access-Control-Allow-Methods': 'POST, OPTIONS'
        },
        'body': json.dumps(response_body, ensure_ascii=False)
    }
```

### Amazon Bedrock 設定

**モデル設定**
```
Model ID: anthropic.claude-3-sonnet-20240229-v1:0
Max Tokens: 2000
Temperature: 0.1 (一貫性重視)
Top P: 0.9
```

**権限設定（IAM）**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "bedrock:InvokeModel"
      ],
      "Resource": [
        "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0"
      ]
    }
  ]
}
```

## 🚀 デプロイメント仕様

### Vercel 設定

**プロジェクト設定**
```json
{
  "name": "sap-project-frontend",
  "framework": "vite",
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm install",
  "devCommand": "npm run dev"
}
```

**環境変数**
```
VITE_API_ENDPOINT=https://ylgrnwffx6.execute-api.us-east-1.amazonaws.com
NODE_VERSION=18.x
```

### Vite 設定

**vite.config.ts**
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    proxy: {
      '/api': {
        target: 'https://ylgrnwffx6.execute-api.us-east-1.amazonaws.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
})
```

## 📊 パフォーマンス仕様

### フロントエンド

**バンドルサイズ目標**
- メインバンドル: <500KB
- チャンクファイル: <200KB each
- 静的アセット: <100KB total

**ランタイムパフォーマンス**
- 初期レンダリング: <100ms
- ファイルアップロード: <1s (1MB以下)
- グラフ描画: <500ms
- API レスポンス: <3s

### バックエンド

**Lambda パフォーマンス**
- Cold Start: <1s
- Warm Execution: <500ms
- Bedrock API Call: <2s
- Memory Usage: <512MB

**API Gateway**
- Request/Response: <100ms
- Error Rate: <1%
- Availability: >99.9%

## 🔒 セキュリティ仕様

### フロントエンド

**データ保護**
- CSVデータは一時的メモリ保存のみ
- localStorage使用なし
- セッション終了時データクリア

**HTTP セキュリティ**
- HTTPS強制（Vercel）
- CORS適切設定
- XSS対策（React自動エスケープ）

### バックエンド

**AWS セキュリティ**
- IAM最小権限原則
- VPC設定なし（Lambdaパブリック）
- CloudWatch ログ監視

**データ処理**
- 個人情報自動除外
- データ永続化なし
- ログ機密情報マスキング

---

**作成日**: 2025年8月18日  
**最終更新**: 2025年8月18日  
**バージョン**: 1.0