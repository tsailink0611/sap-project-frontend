# 🧪 テストガイド - Strategic AI Platform

## 📋 テスト項目チェックリスト

### 1. 基本機能テスト

#### 1.1 ファイルアップロード
- [ ] **CSV (UTF-8)**: `test-data/sample-sales.csv`をアップロード
- [ ] **CSV (Shift-JIS)**: `test-data/sample-sales-sjis.csv`をアップロード  
- [ ] **Excel**: 任意のExcelファイルをアップロード
- [ ] **ドラッグ&ドロップ**: ファイルをドラッグ&ドロップでアップロード

**期待される結果**:
```
✅ [ファイル名] を正常にアップロードしました。
📊 データ行数: XX行
📋 カラム名: 日付, 商品名, 売上金額, ...
```

#### 1.2 データ分析
- [ ] 「売上トレンドを分析して」と入力して送信
- [ ] 「商品別の売上を分析して」と入力して送信
- [ ] 「グラフを表示して」ボタンをクリック
- [ ] データテーブル表示/非表示の切り替え

**期待される結果**:
- JSON形式の構造化された分析結果
- KPIの数値表示
- 洞察の箇条書き表示

### 2. フォーマット学習テスト

#### 2.1 初回アップロード
1. 新しい形式のCSVをアップロード
2. フォーマット学習UIが表示される
3. カラムマッピングを設定:
   - 日付 → date
   - 売上金額 → sales
   - 商品名 → product
4. 「学習データを保存」をクリック

**期待される結果**:
```
✅ フォーマット学習を保存しました！次回から自動的に適用されます。
```

#### 2.2 学習済みフォーマットの再利用
1. 同じ形式のファイルを再度アップロード
2. 自動的にカラムが認識される

**期待される結果**:
```
🎯 学習済みフォーマット
このデータ形式は学習済みです。
学習済み列数: X
```

### 3. AI使用量表示テスト

#### 3.1 使用量ウィジェット
- [ ] 画面右下に使用量ウィジェットが表示される
- [ ] クリックで詳細表示が展開される
- [ ] 使用量のプログレスバーが正しく表示される
- [ ] 「使用量を更新」ボタンで最新データを取得

**期待される表示**:
```
📊 AI使用量 (2025-08)
[====>    ] 45.2%
$4.52 / $100.00
```

### 4. エラーハンドリングテスト

#### 4.1 大容量ファイル
- 10MB以上のファイルをアップロード

**期待される結果**:
```
❌ ファイルサイズが大きすぎます（最大10MB）
```

#### 4.2 不正な形式
- テキストファイルやPDFをアップロード

**期待される結果**:
```
❌ サポートされていないファイル形式です。CSV、Excel形式のファイルをアップロードしてください。
```

#### 4.3 API接続エラー
- ネットワークを切断して送信

**期待される結果**:
```
🔴 APIエラーが発生しました:
APIサーバーからのレスポンスがありません。
```

## 🔍 デバッグ方法

### ブラウザコンソールの確認
```javascript
// 開発者ツールを開く (F12)
// Consoleタブで以下を確認:

// データ確認
console.log('salesData:', salesData);
console.log('API Response:', result.data);

// エラー確認
console.error('Error details:', error);
```

### Lambda関数のログ確認
```bash
# CloudWatch Logsで確認
aws logs tail /aws/lambda/sap-claude-handler-v2 --follow

# 特定のリクエストIDで検索
aws logs filter-log-events \
  --log-group-name /aws/lambda/sap-claude-handler-v2 \
  --filter-pattern "request_id=xxx"
```

### Supabaseデータ確認
1. Supabase Dashboardにログイン
2. Table Editorを開く
3. 以下のテーブルを確認:
   - `format_profiles`: フォーマットプロファイル
   - `column_mappings`: カラムマッピング
   - `ai_usage`: AI使用量記録

## 🐛 よくある問題と解決方法

### 問題1: フォーマット学習が保存されない

**原因**: Supabase接続エラー
**解決方法**:
1. Lambda環境変数を確認
2. Supabaseのservice keyが正しいか確認
3. テーブルが作成されているか確認

### 問題2: JSON形式のレスポンスが表示されない

**原因**: Claude APIが旧形式で応答
**解決方法**:
1. Lambda関数が`v2`バージョンか確認
2. プロンプトにJSON形式の指示が含まれているか確認

### 問題3: 使用量が0のまま

**原因**: ai_usageテーブルへの記録失敗
**解決方法**:
1. RLSポリシーを確認
2. service_roleの権限を確認

## 📊 パフォーマンステスト

### レスポンス時間の目標値
- ファイルアップロード: < 1秒
- AI分析（10行）: < 3秒
- AI分析（100行）: < 5秒
- グラフ描画: < 500ms

### 負荷テスト
```bash
# 簡易負荷テスト（10回連続リクエスト）
for i in {1..10}; do
  curl -X POST https://your-api.execute-api.us-east-1.amazonaws.com/ \
    -H "Content-Type: application/json" \
    -d '{"prompt":"テスト分析 '$i'","tenantId":"test"}' &
done
wait
```

## 🎯 受入テスト基準

すべての項目が以下の基準を満たすこと:

1. **機能性**: すべてのチェックリスト項目が✅
2. **性能**: レスポンス時間が目標値以内
3. **信頼性**: 10回連続実行で失敗なし
4. **使いやすさ**: エラーメッセージが明確
5. **互換性**: Chrome, Firefox, Safariで動作

---

**最終更新**: 2025-08-23
**バージョン**: 1.0.0